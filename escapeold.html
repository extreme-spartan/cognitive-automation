<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ExtremeSpartan - Cognitive Automation</title>
    <!-- Latest compiled and minified CSS -->
  <link href="./scripts/widget-5d9a4e95309cd5de5d5b-prod.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script> -->

  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

  <script src="./public/libraries/p5.js" type="text/javascript"></script>
  <!-- <script src="libraries/p5.dom.js" type="text/javascript"></script> -->
  <!-- <script src="libraries/p5.sound.js" type="text/javascript"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js" integrity="sha512-bcfltY+lNLlNxz38yBBm/HLaUB1gTV6I0e+fahbF9pS6roIdzUytozWdnFV8ZnM6cSAG5EbmO0ag0a/fLZSG4Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> 
  <script src="./public/sketch.js" type="text/javascript"></script>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js" type="text/javascript"></script> 
   <script>
    // var announcementText = "Hello Welcome to the World of Cognitive Computing!!";
    // var utterance = new SpeechSynthesisUtterance(announcementText);
    // utterance.lang = 'en-US';
    // utterance.rate = 1.0;
    // utterance.volume = 1.0;
    // utterance.pitch = 1.0;
    // speechSynthesis.speak(utterance); 
    // var uname = "";
    $(document).ready(function () {
      $(".hideOnStartup").hide();
      $.getJSON("/protected", function (data) {
        // Already authenticated
        $("#WhenAuthenticated").show();
        $("#logoutButton").show();
        $("#name").text(data.name);
        $("#email").text(data.email);
      }).fail(function () {
        // Not authenticated yet
        $("#WhenNotAuthenticated").show();
        $("#loginButton").show();
      }).always(function() {
                var languageQuery = window.location.href.slice(window.location.href.indexOf('?'));
                var changeDetails = document.getElementById('changeDetails');
                changeDetails.href = "/ibm/cloud/appid/cloudLand/view/change/details" + languageQuery;
                var changePassword = document.getElementById('changePassword');
                changePassword.href = "/ibm/cloud/appid/cloudLand/view/change/password" + languageQuery;

                var signUp = document.getElementById('signUp');
                changePassword.href = "/ibm/cloud/appid/view/sign_up" + languageQuery;


              });
    });

    var wakeWord = false;
    var wCnt = 0;
    // var Shp;
  </script>
    
  <style>

    * {
      font-family: Verdana, Arial, sans-serif;
    }
    a:link {
      color:#000;
      text-decoration: none;
    }
    a:visited {
      color:#000;
    }
    a:hover {
      color:#33F;
    }
    .button {
      background: -webkit-linear-gradient(top,#008dfd 0,#0370ea 100%);
      border: 1px solid #076bd2;
      border-radius: 3px;
      color: #fff;
      display: none;
      font-size: 12px;
      font-weight: bold;
      line-height: 1.3;
      padding: 4px 8px;
      text-align: center;
      text-shadow: 1px 1px 1px #076bd2;
      letter-spacing: normal;
    }
    .center {
      padding: 10px;
      text-align: center;
    }
    .final {
      color: black;
      padding-right: 3px; 
    }
    .interim {
      color: gray;
    }
    .info {
      font-size: 12px;
      text-align: center;
      color: #777;
      display: none; 
    }
    .right {
      float: right;
      position:relative;
      top:0%;
      right:0%;
    } 
    .sidebyside {
      display: inline-block;
      width: 45%;
      min-height: 40px;
      text-align: left;
      vertical-align: top;
    }
    .card {
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    transition: 0.3s;
    width: 40%;
    border-radius: 5px;
  }

  .flip-card {
    background-color: transparent;
    width: 150px;
    height: 150px;
    perspective: 1000px;
  }

  .flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
  }

  .flip-card:hover .flip-card-inner {
    transform: rotateY(180deg);
  }

  .flip-card-front, .flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .flip-card-front {
    background-color: #bbb;
    color: black;
  }

  .flip-card-back {
    background-color: #2980b9;
    color: white;
    transform: rotateY(180deg);
  }
    #headline {
      font-size: 40px;
      font-weight: 300;
    }
    #info {
      font-size: 14px;
      text-align: left;
      color: #777;
      visibility: hidden;
    }
    #info_pos {
      position:relative;
      padding-top: 3px;
    }
    #results {
      font-size: 12px;
      font-weight: bold;
      border: 1px solid #ddd;
      padding: 5px;
      text-align: left;
      min-height: 50px;
    }

    #history_areaa {
      font-size: 12px;
      border: 0px solid #ddd;
      padding-top: 0px;
      text-align: left;
      vertical-align: bottom;
      overflow: visible;
      max-width: 100%;
      min-height: 40%;
      max-height: 40%;
    }
    #text_areaa {
      font-size: 14px;
      font-weight: bold;
      border: 0px solid #ddd;
      padding: 1px;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      display: inline;
    }
    #chatInput {
      font-size: 14px;
      border: 1px solid #ddd;
      padding: 2px;
      text-align: left;
      width: 100%;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      display: inline;
    }
    
    #imageURLId{
    font-size: 14px;
    font-weight: normal;
    resize: none;
    overflow-y: scroll;
    }
    #start_button {
      border: 0;
      background-color:transparent;
      padding: 0;
    }
    #sends_button {
      border: 0;
      background-color:transparent;
      padding: 0;
    }
    #div_language {
      visibility:visible;
    }

    h2 { 
    position: absolute; 
    top: 200px; 
    left: 0; 
    width: 100%; 
    }
    div.img {
      border: 10px solid #ccc;
      float: center;
      max-width: 400px;
      max-height: 250px;
    }
    div.ex2 {
      max-width: 100%;
      margin: auto;
      border: 3px solid #73AD21;
    }
    div.img:hover {
      border: 1px solid #777;
    }


    div.desc {
      padding: 15px;
      text-align: center;
    }

    #vdo, .avcontrol {
      max-width:100%;
      border: 0px solid #ccc;
      float: center;
    }
    #vdo {
      display: none;
    }
    video {
      width: 100%;
      height: auto;
      border: 0px solid #def;
    }
    .responsive {
      width: 100%;
      height: auto;
    }
    #panel, .flip {
      font-size: 12px;
      padding: 4px;
      text-align: left;
      background-color: transparent;
      border: solid 1px #def;
    }

    #panel {
      display: block;
    }

    #mydiv {
      position: absolute;
      z-index: 9;
      background-color: #f1f1f1;
      text-align: center;
      border: 1px solid #d3d3d3;
    }

    #mydivheader {
      padding: 5px;
      cursor: move;
      z-index: 10;
      background-color: #2196F3;
      color: #fff;
    }


    .sidenav {
    height: 100%;
    width: 300px;
    position: fixed;
    z-index: 1;
    top: 0;
    right: 0;
    
    overflow-x: hidden;
    padding-top: 20px;
    padding-right: 10px;
    }

    .sidenav a {
    padding: 6px 8px 6px 16px;
    text-decoration: none;
    font-size: 25px;
    color: #818181;
    display: block;
    }

    .sidenav a:hover {
    color: #f1f1f1;
    }

    .main {
    margin-right: 160px; /* Same as the width of the sidenav */
    font-size: 28px; /* Increased text to enable scrolling */
    padding: 0px 10px;
    }

    @media screen and (max-height: 450px) {
    .sidenav {padding-top: 15px;}
    .sidenav a {font-size: 18px;}
    }
    .accordion {
    background-color: #eee;
    color: blue;
    cursor: pointer;
    padding: 5px;
    width: 100%;
    border: none;
    text-align: left;
    text-decoration:underline;
    outline:solid;
    outline-width: 1px;
    outline-color: rgb(222, 18, 18);
    font-size: 15px;
    transition: 0.4s;
    }

    .active, .accordion:hover {
    background-color: #ccc; 
    }

    .panel {
    padding: 0 18px;
    display: none;
    background-color: white;
    overflow: hidden;
    }
    .collapsible {
      background-color: #78f79e;
      color: white;
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 15px;
    }
    .active, .collapsible:hover {
      background-color: #bffc85;
    }
    .content {
    padding: 0 18px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
    background-color: #f1f1f1;
  }
/* Checkbox hack to control information box display */

label {
    font-size: 12px;
    position: relative;
    top: 2px;
    right: 3px;
    z-index: 5;
    cursor: pointer;
    background-color: white;
    border-radius: 10px;
  }

  input[type=checkbox] {
     position: absolute;
     top: -100px;
  }

  aside {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transform: translateX(100%);
    transition: 0.3s all ease-out;
    background-color: transparent;
    padding: 1rem;
  }

  aside p {
    font-size: 1.2rem;
    margin: 0.5rem 0;
  }

  aside a {
    color: #f40707;
  }

  /* Toggled State of information box */
  input[type=checkbox]:checked ~ aside {
    transform: translateX(0);
  }


  .video-container {
            position: relative;
            display: inline-block;
  }

  .overlay {
      position: absolute;
      /* top: 0;  */
      left: 0;
      bottom: 0 ;
      width: 100%;
      height: 39%;
      background-color: rgba(255, 255, 255, 1); /* Change the color and opacity as needed */
      z-index: 1; /* Place the overlay above the video */
  }
        /* Slide-in pane styles */
        .slide-pane {
          position: fixed;
          top: 0;
          right: -400px;
          width: 400px;
          height: 100%;
          background-color: white;
          box-shadow: -3px 0 6px rgba(0, 0, 0, 0.3);
          transition: right 0.3s ease-in-out;
        }
        
        .pane-content {
          padding: 10px;
        }
        
        .close-slide {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
    /* Change the background color of the navbar */
    .navbar {
      background-color: rgb(75, 190, 75); /* Change this to your desired color */
    }

    /* Change the text color of the navbar links */
    .navbar-nav > li > a {
      color: #040101; /* Change this to your desired color */
    }
  </style>
</head>
<body>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      <a class="navbar-brand" href="#">Extreme-Spartan</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li><a id="Home" href="#">Home</a></li>
        <li class="dropdown hideOnStartup" id="WhenAuthenticated">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Accounts
          <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a id="changeDetails">Change details</a></li>
            <li><a id="changePassword">Change password</a></li>
            <li><a href="#">Page 1-3</a></li>
          </ul>
        </li>  
        </ul>             
        <ul class="nav navbar-nav navbar-left ">
          <li>
            <a class="hideOnStartup" href="/ibm/cloud/appid/rop/login" id="loginButton"><span class="glyphicon glyphicon-log-in"></span> Login</a>
            <a class="hideOnStartup" href="/ibm/cloud/appid/logout" id="logoutButton"><span class="glyphicon glyphicon-log-out"></span> Logout</a>
          </li>
          <li><a href="/ibm/cloud/appid/view/sign_up"><span class="glyphicon glyphicon-user"></span> Sign Up</a>
          </li>
        </ul>
    </div>
  </div>
</nav> 
<script type="text/javascript">
  var BASE_KATHA_URL = "";
  var BASE_CMS_URL = "/public/cms";
</script>
<div class="container">
  <div class="row">
    <div class="col-sm-3">
      <div id="drift-widget-container" style="position: absolute; z-index: 2147483647;">
        <div id="mydiv" style="border: none; display: block; height: 220px !important; width: 300px !important; position: fixed; top: auto; left: auto; top: 4%; right: 0px; visibility: visible; z-index: 2147483647; max-height: 100vh; max-width: 100vw; transition: none; background: none transparent; opacity: 1;">
          <!-- <div class="sidenav"> -->

              <div class="flex-center">
                <div class="flex-column flex-1">
                  <div id="WhenNotAuthenticated" class="hideOnStartup">
                  <br><br> Not Authenticated :( 
                  </div>
                    <img id="usrImg" src="" class="responsive">
                    <div class="video-container">
                      <video id="usrVideo"  playsinline autoplay muted loop poster="" style='display: none;'> <!-- ./public/images/thumbnail.jpeg-->
                        <source id="mp4_src" src="" type="video/mp4">
                              Your browser does not support HTML5 video.
                      </video>
                      <div class="overlay">
                        <div id="history_area" class="responsive" style='display: none;'>
                          <textarea readonly class="form-control" id="historyArea" style="color:#777;background-color:transparent;border:1px solid #ddd;font-size:12px;width:100%;height:115px;resize:none;overflow-y:scroll;">
                          </textarea>                         
                        </div>
                      </div>
                    </div>  
                    <div class="_3NF-ok9QLIxL_8hJP-wqln flex-column">
                      <div class="_3me6Qx7Oc-d8q01pJiZkW-">
                        <span>
                          <div class="flex-center dsg-Regular color-gray-dark _30acjYOY3KpZb6rcrQtycV">
                            <div id="vdo" class="responsive" >
                              <button id="btn_play" onclick="playVid()" >Play Video</button>
                              <button id="btn_pause" onclick="pauseVid()" >Pause Video</button>
                              <button id="btn_mute" onclick="enableMute()" >Mute Video</button>
                              <button id="btn_sound" onclick="disableMute()" >Unmute Video</button>
                            </div>                                
                          </div>
                        </span>
                      </div>
                    </div>
                    <section id='appinfo' style='display: none;'>
                      <div id='mobinp'>
                        <input type="file" name="video" accept="video/*,image/*" >
                      </div>
                      <div id='dskinp'>
                        <button id="capture" onclick="snapClick()">Capture</button>
                        <video id="player" class="responsive" playsinline autoplay></video>
                        <!-- <canvas id="snapshot" width=200 height=150 style="display:none;"></canvas> -->
                      </div>
                    </section>
                                                                    
                              <!-- <div id="history_area" class="responsive">
                                <textarea readonly class="form-control" id="historyArea" style="color:#777;background-color:transparent;border:1px solid #ddd;font-size:12px;width:100%;height:115px;resize:none;overflow-y:scroll;">
                                </textarea>
                                                          
                              </div> -->

                    <!-- <div class="_29vw7TuPr8BvnPmQim9SyX"> -->
                      <p id="charCount" style='display: none;'>0 characters</p>
                      <input id="chatInput" type="text" class="form-control" placeholder="Type in text here .. " autofocus="autofocus" onkeyup="send_txt(id)" oninput="countCharacters()"/>
                        <!-- <div class="_3NF-ok9QLIxL_8hJP-wqln flex-column"> -->
                        <div class="_3me6Qx7Oc-d8q01pJiZkW-">
                          <span>
                            <div class="flex-center dsg-Regular color-gray-dark _30acjYOY3KpZb6rcrQtycV">
                                <button style="color: blue" id="send_button" onclick="sendButton(event)">Send</button>
                            </div>
                          </span>
                        </div>
                        <!--   </div> -->
                    <!-- </div>                               -->

                </div> <!-- "flex-column flex-1" -->
                          <!--<div class="TSuRK-6Q45wskduuptJBi" style="background-image: url(https://katha.mycloud.net/KathaCms/content/topic/Katha-girl2.png);"> -->
              </div> 


                <div id="panel">
                  <div id="info">
                    <p id="info_start">Click on the microphone icon and begin speaking.</p>
                    <p id="info_speak_now">Speak now. When done, click on the microphone icon.</p>
                    <p id="info_no_speech">No speech was detected. You may need to adjust your
                      <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
                        microphone settings</a>.</p>
                    <p id="info_no_microphone" style="display:none">
                      No microphone was found. Ensure that a microphone is installed and that
                      <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
                      microphone settings</a> are configured correctly.</p>
                    <p id="info_allow">Click the "Allow" button above to enable your microphone.</p>
                    <p id="info_denied">Permission to use microphone was denied.</p>
                    <p id="info_blocked">Permission to use microphone is blocked. To change,
                      go to chrome://settings/contentExceptions#media-stream</p>
                    <p id="info_upgrade">Web Speech API is not supported by this browser.
                        Upgrade to <a href="//www.google.com/chrome">Chrome</a>
                        version 25 or later.</p>
                  </div>
                  <div class="right">
                    <button id="start_button" onclick="startButton(event)">
                      <img id="start_img" src="mic.gif" alt="Start">
                    </button>
                  </div>
                  <div id="results">
                    <span id="final_span" class="final"></span>
                    <span id="interim_span" class="interim"></span>
                  </div>
                  <section id='chglang' style='display: none;'>
                    <div class="center">
                      <div id="div_language">
                        <select id="select_language" onchange="updateCountry()"></select>&nbsp;&nbsp;<select id="select_dialect"></select>&nbsp;&nbsp;<input id="statusLine" type="text" disabled="disabled">
                      </div>
                    </div>
                  </section>
                </div>
          <!-- </div> -->

              </div> <!---"flex-center"-->

        </div> <!-- mydiv -->
        </div> <!-- drift-widget-container -->
      </div>
    </div> <!-- col-sm-3 -->
    <div class="col-sm-9">
      <section class="sound-clips">
      
      
      </section>        
            <!-- <div id="imgDiv">
            <img class="center-block" id="logo" alt="logo"
                style="height: 80%; width: 80%; object-fit: contain;margin-top: 40px" src="https://responsivevoice.org/wp-content/uploads/2020/01/parrot-flight.png">
        </div> -->


        <!-- <div id="WhenNotAuthenticated" class="hideOnStartup">
            <h3>You're not authenticated :(</h3>
        </div>

        <div id="WhenAuthenticated" class="hideOnStartup">
            <h3>You're authenticated :)</h3>
            <h3>Hello <span id="name"></span></h3>
            <h4>Your email is <span id="email"></span></h4>
            <br/><br/>
            <a class="btn btn-lg btn-primary btn-login" id="changeDetails">Change details</a>
            <a class="btn btn-lg btn-primary btn-login" id="changePassword">Change password</a>
            <a class="btn btn-primary" href="/spn">SPN</a>
            <button class="btn btn-primary" style="color: blue" id="send_button" onclick="initiate()">Send</button>
        </div> -->

        <img id="waitImg" class="responsive">
        
        <div id="tcon"></div>
        <!-- <label for="toggle"></label> -->
        <input type="checkbox" id="toggle"> 
        <aside id="asideLabel">
          <img id="cmsImg" > 





        </aside>          

      

      
      
      
                  
        
        <!-- <video id="myVideo"  playsinline autoplay muted loop>
            <source id="mp4_src" src="" type="video/mp4">
                    Your browser does not support HTML5 video.
        </video>      
        <div id="vdo" class="responsive" >
          <button id="btn_play" onclick="playVid()" >Play Video</button>
          <button id="btn_pause" onclick="pauseVid()" >Pause Video</button>
          <button id="btn_mute" onclick="enableMute()" >Mute Video</button>
          <button id="btn_sound" onclick="disableMute()" >Unmute Video</button> 
        </div>  -->
        

    </div>
  </div>
</div>

<script type="text/javascript">

    var aaa = '';

    function initiate(assistantid) {
      //alert('SPN initiate '+assistantid);
      var url = "initiate";
      var jsondata = { assistant_id: assistantid };
      
      ajaxJSONPosta(url, jsondata, function(response) {
        // alert(JSON.stringify(response.result)); 
        sessionid = response.result.session_id;
        userrole = response.role;

        historyArea.value += sessionid.trim() + '\n';
        historyArea.scrollTop = historyArea.scrollHeight;
        //alert(sessionid); 
        // sendConverse("Jargon of the day");
      });
    }   

    function ajaxJSONPostb(url, jsondata, callback) {
      //alert('ajaxJSONPost');
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      //xhr.setRequestHeader('Access-Control-Allow-Origin', 'https://botalicious.herokuapp.com');
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            console.log("Received response=" + xhr.responseText);

            alert('SPN in ajaxJSONPosta*** '+ xhr.responseText);

            callback(xhr.responseText);

        } else {

          //alert("Return status = " + xhr.status);
          document.getElementById('tcon').value = "Return status = " + xhr.status;
        }
      }
      xhr.send(JSON.stringify(jsondata));
      //alert('after Send '+JSON.stringify(jsondata));
      //console.log("Sent to "+url+", data=" + JSON.stringify(jsondata));
    }    

</script>
<script>

var input = document.querySelector('input[type=file]'); // see Example 4

input.onchange = function () {
  var file = input.files[0];

  //upload(file);
  //drawOnCanvas(file);   // see Example 6
  displayAsImage(file); // see Example 7
};

function upload(file) {
  var form = new FormData(),
      xhr = new XMLHttpRequest();

  form.append('image', file);
  xhr.open('post', 'server.php', true);
  xhr.send(form);
}

function drawOnCanvas(file) {

  //alert(file);
  var reader = new FileReader();

  reader.onload = function (e) {
    var dataURL = e.target.result,
        c = document.querySelector('canvas'), // see Example 4
        ctx = c.getContext('2d'),
        img = new Image();

    img.onload = function() {
      c.width = img.width;
      c.height = img.height;
      ctx.drawImage(img, 0, 0);
    };

    img.src = dataURL;
  };

  reader.readAsDataURL(file);
} 

function displayAsImage(file) {
  var imgURL = URL.createObjectURL(file),
      img = document.createElement('img');

  img.onload = function() {
    URL.revokeObjectURL(imgURL);
  };

  img.src = imgURL;
  document.getElementById("cmsImg").src = img.src;
  document.body.appendChild(img);
}

</script>

    
    <script>
      var controller = null;
      var player = document.getElementById('player'); 
      // var snapshotCanvas = document.getElementById('snapshot');
      var captureButton = document.getElementById('capture');
      var video1 = document.getElementById("usrVideo");
      var videoTracks;
      //videoTracks.forEach(function(track) {track.stop()});
      var canStream;
      var theStream;
      var theRecorder;
      var recordedChunks = [];     
      var responseText = ""; 
      // var ctx = snapshotCanvas.getContext("2d");
      
      
      var handleSuccess = function(stream) {
          // Attach the video stream to the video element and autoplay.
          theStream = stream;
          player.srcObject = stream;
          player.captureStream = player.captureStream || player.mozCaptureStream;
          videoTracks = stream.getVideoTracks();
        try {
          recorder = new MediaRecorder(stream, {mimeType : "video/webm"});
        } catch (e) {
          console.error('Exception while creating MediaRecorder: ' + e);
          return;
        }
        theRecorder = recorder;
        recorder.ondataavailable = 
            (event) => { recordedChunks.push(event.data); };
        // recorder.start(10);      
      };

      // var handleSuccess = function(stream) {
      //   // Attach the video stream to the video element and autoplay.
      //   player.srcObject = stream;
      //   videoTracks = stream.getVideoTracks();
      // };
      function download() {
      theRecorder.stop();
      // theStream.getTracks().forEach(track => { track.stop(); });

      const clipName = inputText.toUpperCase().substr(5);
      //alert(clipName);
      
        const clipContainer = document.createElement('article');
        const clipLabel = document.createElement('p');
        const video = document.createElement('video');
        const deleteButton = document.createElement('button');
        const downloadButton = document.createElement('button');

        clipContainer.classList.add('clip');
        video.setAttribute('autoplay', 'true');
        video.setAttribute('loop', 'false');
        video.setAttribute('controls', 'true');
        video.setAttribute('type', 'video/webm');
        //audio.setAttribute('type', 'video/webm');
        //audio.setAttribute('src', '/chords/drum120.wav');
        deleteButton.textContent = 'Delete';
        deleteButton.className = 'delete';
        downloadButton.textContent = 'Download';
        downloadButton.className = 'download';

        clipContainer.appendChild(video);
        clipContainer.appendChild(clipLabel);
        clipContainer.appendChild(deleteButton);
        clipContainer.appendChild(downloadButton);
        tcon.appendChild(clipContainer);

      video.controls = true;

      var blob = new Blob(recordedChunks, {type: "video/webm"});
      //recordedChunks[];
      var url =  URL.createObjectURL(blob);

      var mUrl = url.slice(-36).replace(/-/g, "");


      video.src = url;

      alert(mUrl);

          var formdata = { issue: url, buildingName: clipName, weekDay: 'fi03value', dayTime: 'fi04value', phone: 'test.webm' };

         //  var aurl = "http://localhost:3001/saveav";

          // ajaxJSONPosta(aurl, formdata, function(mresult) {

          //     responseText = JSON.stringify(mresult);
          //     alert(responseText);

          // });

      deleteButton.onclick = function(e) {
        let evtTgt = e.target;
        evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
      }
      // function xhrAttach(url, data, callback, errback)
      // {
      //  //alert('SPNURL '+ url);
      //  var xhr = new createXHR();
      //  xhr.open("POST", url, true);
      //  xhr.setRequestHeader("Content-type", "multipart/form-data");
      //  xhr.onreadystatechange = function(){
      //    if(xhr.readyState == 4){
      //      if(xhr.status == 200){
      //        callback(parseJson(xhr.responseText));
      //      }else{
      //        errback('service not available');
      //      }
      //    }
      //  };
      //  xhr.timeout = 1000000;
      //  xhr.ontimeout = errback;
      //  xhr.send(data);
      // }
          

      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      a.href = url;
      a.download = 'test.webm';
      a.click();
      // setTimeout() here is needed for Firefox.
      setTimeout(function() { URL.revokeObjectURL(url); }, 100); 
      // toggleAppInfo();
      return;
    }
      function snapClick() {

        siteControls('snapClick');

        return;

        var context = snapshot.getContext('2d');
        context.drawImage(player, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
      //ImgData = context.getImageData(0, 0, snapshotCanvas.width, snapshotCanvas.height);
        var fullQuality = snapshotCanvas.toDataURL("image/jpeg", 1.0);


        var image = new Image();
        image.src = snapshotCanvas.toDataURL("image/png");
      //alert(fullQuality);

        document.getElementById("cmsImg").src = image.src;     

        snapshotCanvas.toBlob(function(blob) {
          //var newImg = document.createElement("cframe"),
          burl = URL.createObjectURL(blob);

          //alert('BURL ' + burl);


          //alert('IN SPN Capture');
          var imgg = document.getElementById("snapshot").toDataURL("image/jpeg", 1.0);
          //alert(imgg);
          var url = "https://spnize.mycloud.net/captureImage";
          var jsondata = { requestId: "12345678", persona: "Hello", name: "Sridhar", value: "SSSSSS",base64: imgg, mUrl: burl }; //, base64: imgg mUrl: burl

                ajaxJSONPost(url, jsondata, function(response) {
                 // alert(JSON.stringify(response));

                    //responsiveVoice.speak(response.successDetails.conversationText);
                    //historyArea.value += 
                    //  response.successDetails.conversationText + "\n";
                    //historyArea.scrollTop = historyArea.scrollHeight; 
                });

                function ajaxJSONPost(url, jsondata, callback) {
                  var xhr = new XMLHttpRequest();
                  xhr.open("POST", url);
                  xhr.setRequestHeader('Content-Type', 'application/json');
                  xhr.setRequestHeader("Cache-Control", "no-cache");
                  //xhr.setRequestHeader("X-File-Name", file.jsondata);
                  //xhr.setRequestHeader("X-File-Size", file.jsondata);
                  //xhr.setRequestHeader("Content-Type", "multipart/form-data");
                  xhr.onreadystatechange = function() {
                  if (xhr.readyState == 4 && xhr.status == 200) {
                      console.log("Received response=" + xhr.responseText);
                      callback(JSON.parse(xhr.responseText));
                    }
                    else {
                      document.getElementById('statusLine').value = "Return status = "+xhr.status;
                    }
                  }
                  xhr.send(JSON.stringify(jsondata));
                  console.log("Sent to "+url+", data=" + JSON.stringify(jsondata));
                }


            });


      }


      //navigator.mediaDevices.getUserMedia({video: { facingMode: "user" }}).then(handleSuccess).catch(handleError);
  </script>
<script>
//Make the DIV element draggagle:
dragElement(document.getElementById("mydiv"));

function dragElement(elmnt) {
  var pos1 = 100, pos2 = 0, pos3 = 0, pos4 = 0;
  if (document.getElementById(elmnt.id + "header")) {
    /* if present, the header is where you move the DIV from:*/
    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
  } else {
    /* otherwise, move the DIV from anywhere inside the DIV:*/
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    /* stop moving when mouse button is released:*/
    document.getElementById("chatInput").focus();
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
</script>
<script>

function chglang(){
  var nde = document.getElementById('chglang');
  nde.style.display = nde.style.display == 'none' ? '' : 'none';
  if (nde.style.display == '') {
    document.getElementById("chglang").style.display = 'block';

  } else {
    document.getElementById("chglang").style.display = 'none';

  }

}


function toggleAppInfo(){
    var node = document.getElementById('appinfo');
  
  function hasGetUserMedia() {
    return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  }
  // hasGetUserMedia();
  if (hasGetUserMedia()) {
  // Good to go!
    document.getElementById("dskinp").style.display = 'block';
    //alert('Good to go!');
    document.getElementById("mobinp").style.display = 'none';
  } else {
    //alert('getUserMedia() is not supported by your browser');
    document.getElementById("mobinp").style.display = 'block';
    document.getElementById("dskinp").style.display = 'none';
  }

    node.style.display = node.style.display == 'none' ? '' : 'none';
    if (node.style.display == '') {
        navigator.mediaDevices.getUserMedia({video: true}).then(handleSuccess);
    } else {
        videoTracks.forEach(function(track) {track.stop()});
    }
    
}   


function qrcode() {
  ctr = ctr+1;

  let bid = 'btn'+ctr.toString();

  var btn = document.createElement("button");
  btn.setAttribute("class", "accordion");
  btn.setAttribute("id", bid);
  btn.setAttribute("onclick","myFunction()");

  var t = document.createTextNode(inputText);
  btn.appendChild(t);
  //para.appendChild(btn);
  document.getElementById("tcon").appendChild(btn);
  
  var dv = document.createElement("DIV");
  dv.setAttribute("class", "panel");
  dv.setAttribute("style", "display: block;");
  dv.setAttribute("ID", "qrcode");

  var tt = document.createTextNode("QR Code Response");
  dv.appendChild(tt);
  document.getElementById("tcon").appendChild(dv);




  let cvsid = 'can-'+ctr.toString();


  var can = document.createElement("DIV");
  // can.setAttribute("style", "width:100%;")

  can.setAttribute("ID", cvsid);


  dv.appendChild(can);
  document.getElementById("tcon").appendChild(dv);


  const myList = document.querySelector('#tcon')
  const lastListItem = myList.lastElementChild;
  myList.insertBefore(lastListItem, myList.firstElementChild)
  const lastListItem2 = myList.lastElementChild;
  myList.insertBefore(lastListItem2, myList.firstElementChild)

  // Get the URL of the current page
  var currentURL = window.location.href;

  // Generate QR code using the URL
  var qrcode = new QRCode(document.getElementById(cvsid), {
    text: currentURL,
    width: 128,
    height: 128
  });

  inputText = "";
  return;
}

function saveFunc(){
  alert('empty implementation');
  
}

function swapVideo() {

  //alert('vid src',vid.src);

  if (vid.src==""){
      cmsImg.src = usrImg.src;
      document.getElementById("cmsImg").src = "";
      document.getElementById("cmsImg").style.display = "block";
  }
  if (vid.style.display == "block" ) 
  { 
      vidct=vid.currentTime;
      uvid.src = vid.src;
      
      vid.style.display = "none";
      //vid.load();
      uvid.style.display = "block";
      uvid.currentTime=vidct;
      //uvid.load();


  } 
  if (uvid.src=="s"){
      usrImg.src = cmsImg.src;
      document.getElementById("usrImg").src = usrImg.src;
      document.getElementById("usrImg").style.display = "block";   
  
    if (uvid.style.display == "block" ){

      uvidct=uvid.currentTime;
      vid.src = uvid.src;
      vid.style.display = "block";
      vid.currentTime=uvidct;
      //vid.load();
      uvid.style.display = "none";
      //uvid.load();

    }
    if (uvid.style.display == "none" ){

      uvidct=uvid.currentTime;
      vid.src = uvid.src;
      vid.style.display = "block";
      vid.currentTime=uvidct;
      //vid.load();
      uvid.style.display = "none";
      //uvid.load();
    }    
  }
}

function showAVControl() {
    if (document.getElementById("vdo").style.display == "block" ) 
    {
        document.getElementById("vdo").style.display = "none";
    } else {
        document.getElementById("vdo").style.display = "block";
    }
}
function showMic() {
    if (document.getElementById("panel").style.display == "block" ) 
    {
        document.getElementById("panel").style.display = "none";
    } else {
        document.getElementById("panel").style.display = "block";
    }
}


function show_send_btn(style) {
  if (chatInput.value.length == 0) {
    //send_button.style.display = 'none';
  } else {
    //send_button.style.display = 'block';
  }
  
}


var vid = document.getElementById("myVideo");
var uvid = document.getElementById("usrVideo");


function playVid() {
    //vid.play();
    chatInput.value = 'play video';
    document.getElementById("chatInput").focus();
    btn_play.style.display = 'none';
    btn_pause.style.display = 'inline-block';
    show_send_btn()
}
function pauseVid() {
    //vid.pause();
    chatInput.value = 'pause video';
    document.getElementById("chatInput").focus();
    btn_play.style.display = 'inline-block';
    btn_pause.style.display = 'none';
    show_send_btn()
}
function setFullVolume() { 
    vid.volume = 1.0;
} 
function enableMute() { 
    //vid.muted = true;
    chatInput.value = 'mute sound';
    document.getElementById("chatInput").focus();
    btn_mute.style.display = 'none';
    btn_sound.style.display = 'inline-block';
    show_send_btn()
}
function disableMute() {
    //vid.muted = false;
    chatInput.value = 'enable sound';
    document.getElementById("chatInput").focus();
    btn_mute.style.display = 'inline-block';
    btn_sound.style.display = 'none';
    show_send_btn()
}

    var globalSessionId = "uninitialized";
    var imagePlayInterval = 15000; // 15 secs default
    var globalContentJsonObj;
    var historyArea = document.getElementById('historyArea');
    historyArea.value = '';
    var jsonUri = '';
    var assistantid = 'b51117b9-3e1c-4777-a2ff-22849f8add4a';
    // var assistantid = 'e002427d-6b2b-4076-9887-f5b0fe757c79';
    var sessionid ='';
    
    function ajaxJSONPost(url, jsondata, callback) {
     // alert('ajaxJSONPost');
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url);
      xhr.setRequestHeader('Content-Type', 'application/json');
      //xhr.setRequestHeader('Access-Control-Allow-Origin', 'https://botalicious.herokuapp.com');
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          console.log("Received response=" + xhr.responseText);

          //alert('in ajaxJSONPost '+xhr.responseText);

          callback(JSON.parse(xhr.responseText));
        }
        else {

          //alert("Return status = " + xhr.status);
            document.getElementById('statusLine').value = "Return status = " + xhr.status;
        }
      }
      xhr.send(JSON.stringify(jsondata));
      //alert('after Send '+JSON.stringify(jsondata));
      console.log("Sent to "+url+", data=" + JSON.stringify(jsondata));
    }
    
    function kathaInitiate() {

      var url = BASE_KATHA_URL + "/initiate";
      var jsondata = { requestId: "12345678", persona: "Boy1" };
      
      ajaxJSONPost(url, jsondata, function(response) {
        globalSessionId = response.sessionId;
       // alert(JSON.stringify(response));
          jsonUri = BASE_CMS_URL + '/' + response.successDetails.contentUri;

          alert(jsonUri);

          aloadJson(jsonUri, response);

      });
    }
    



    function ajaxJSONPosta(url, jsondata, callback) {
      //alert('ajaxJSONPost');
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url);
      xhr.setRequestHeader('Content-Type', 'application/json');
      //xhr.setRequestHeader('Access-Control-Allow-Origin', 'https://botalicious.herokuapp.com');
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          console.log("Received response=" + xhr.responseText);

          //alert('in ajaxJSONPosta*** '+xhr.responseText);

          callback(JSON.parse(xhr.responseText));
        }
        else {

          //alert("Return status = " + xhr.status);
            document.getElementById('statusLine').value = "Return status = " + xhr.status;
        }
      }
      xhr.send(JSON.stringify(jsondata));
      //alert('after Send '+JSON.stringify(jsondata));
      console.log("Sent to "+url+", data=" + JSON.stringify(jsondata));
    }

  var formFlg1 = false;
  var formURL = "";
  var ncnt = 0;
  var html='';
  var ot = "";
  var ctr = 0;
  var bid = '';
  var userMessage = '';
  var baseUrl = 'http://127.0.0.1:5000/process-message';
  var i=0;
  var j, x = "";

  // const populateBotResponse = async (userMessage) => {
  //   await showBotLoadingAnimation();
  //   const response = await processUserMessage(userMessage);
  //   responses.push(response);

  //   const repeatButtonID = getRandomID();
  //   botRepeatButtonIDToIndexMap[repeatButtonID] = responses.length - 1;
  //   hideBotLoadingAnimation();
  //   // Append the random message to the message list
  //   $("#message-list").append(
  //     `<div class='message-line'><div class='message-box${
  //       !lightMode ? " dark" : ""
  //     }'>${
  //       response.openaiResponseText
  //     }</div><button id='${repeatButtonID}' class='btn volume repeat-button' onclick='playResponseAudio("data:audio/wav;base64," + responses[botRepeatButtonIDToIndexMap[this.id]].openaiResponseSpeech);console.log(this.id)'><i class='fa fa-volume-up'></i></button></div>`
  //   );

  //   playResponseAudio("data:audio/wav;base64," + response.openaiResponseSpeech);

  //   scrollToBottom();
  // };

    function loginFunc(inputText) {
            window.location.href = "/ibm/cloud/appid/rop/login";

            // alert('Login >> '+inputText);
            // jsonUri = "cms/content/json/red_riding_hood_summary.json";
            // alert(jsonUri);
            // // aloadJson(jsonUri, response);
            return;
    }

    function sendConverse(inputText) {

      // uvid.src="./public/alice.mp4";

      siteControls(inputText);
      if (inputText.toUpperCase().trim() == "SIGNUP" || inputText.toUpperCase().trim() == "SIGN UP")  {
          window.location.href = "/ibm/cloud/appid/view/sign_up";
          return;
      } 
      if (inputText.toUpperCase().trim() == "LOGIN" )  {
          window.location.href = "/ibm/cloud/appid/rop/login";
          return;
      } 

      if (inputText.toUpperCase().trim() == "QRCODE") {
        inputText = "Steps to scan the QR Code displayed using a mobile device"
      }
      if (inputText.toUpperCase().trim() == "CHART") {
        inputText = "Please Explain the Incident details in the displayed Bar Chart "
      }
      if (inputText.toUpperCase().trim() == "CANVAS") {
        Shp = "onload"
        document.getElementById("toggle").click();
        return;
      }
      if (inputText.toUpperCase().trim() == "USE CASES") {
        Shp = "usecase"
        document.getElementById("toggle").click();
        setTimeout('cloadJson("' + BASE_CMS_URL + '/content/json/aiusecases.json")', 100);

        return;
      }
      if (inputText.toUpperCase().trim() == "INTRO") {
        Shp = "intro"
        // document.getElementById("toggle").click();
        setTimeout('loadJson("' + BASE_CMS_URL + '/content/json/escape101.json")', 100);

        return;
      }
      if (inputText.toUpperCase().substr(0,10) == "FILL COLOR") {
        Fc = inputText.toUpperCase().substr(11);
        return;
      }
      if (inputText.toUpperCase().substr(0,12) == "STROKE COLOR") {
        Sc = inputText.toUpperCase().substr(13);
        return;
      }
      if (inputText.toUpperCase().substr(0,11) == "STROKE SIZE") {
        Ss = float(inputText.toUpperCase().substr(12));
        strokeWeight(Ss);
        return;
      }
      if (inputText.toUpperCase().substr(0,9) == "TEXT SIZE") {
        Ts = float(inputText.toUpperCase().substr(10));
        textSize(Ts);
        return;
      }          
      if (inputText.toUpperCase() == "CLEAR") {
        Cd = 0;
        Shp = '';
        nText = '';
        document.getElementById("chatInput").focus();
        return;
      }
      if (inputText.toUpperCase() == "CLEAR CANVAS") {
        clear();
        return;
      } 
      if (inputText.toUpperCase() == "CLEAR ALL") {
        Cd = 0;
        Shp = '';
        nText = '';
        var list = document.getElementById("tcon");
        while (list.hasChildNodes()) {
            list.removeChild(list.firstChild);
        }
        clear();
        document.getElementById("chatInput").focus(); 
        return;
      } 
      if (inputText.toUpperCase().substr(0,8) == "QCIRCLE(") {

        // alert(inputText.toUpperCase().substr(0,8));
        var ltxt = inputText.toUpperCase().length-8;
        // alert(ltxt);
        var arr = inputText.toUpperCase().substr(8,ltxt-1).split(",");

        // alert(arr);
        coordinateX1 = float(arr[0]);
        coordinateY1 = float(arr[1]);
        Cd = float(arr[2]);
        stroke(Sc);
        strokeWeight(Ss);
        if (Fc != ''){
          fill(Fc);
        } else {
          noFill();
        }

        circle(coordinateX1, coordinateY1, Cd);

        Shp = 'circle'; 
        return;

      } else if (inputText.toUpperCase().substr(0,7) == "QCIRCLE") {
        Cd = float(inputText.toUpperCase().substr(8));
      
        Shp = 'circle';
        return;
      }
      if (inputText.toUpperCase().substr(0,8) == "QSQUARE(") {
        var ltxt = inputText.toUpperCase().length-7;
        //alert(ltxt);
        var arr = inputText.toUpperCase().substr(8,ltxt-1).split(",");
        coordinateX1 = float(arr[0]);
        coordinateY1 = float(arr[1]);
        Cd = float(arr[2]);
        stroke(Sc);
        strokeWeight(Ss);
        if (Fc != ''){
          fill(Fc);
        } else {
          noFill();
        }

        square(coordinateX1, coordinateY1, Cd);

        Shp = 'square';
        return;
      } else if (inputText.toUpperCase().substr(0,7) == "QSQUARE") {
        Cd = float(inputText.toUpperCase().substr(8));
        Shp = 'square';
        return;
      }
      if (inputText.toUpperCase() == "RECTANGLE") {
        Cd = 100;
        Shp = 'rectangle';
        return;

      }          
      if (inputText.toUpperCase() == "TRIANGLE") {
        
        //triangle(118,328, 292, 61, 446, 340);
        Cd = 100;
        Shp = 'triangle';
        return;
      }
      if (inputText.toUpperCase() == "SCRIBBLE") {
        
        //triangle(118,328, 292, 61, 446, 340);
        Cd = 100;
        mCX1 = 0;
        mCY1 = 0;
        mCX2 = 0;
        mCY2 = 0;
        // Fc = 'gold';
        // Sc = 'black';
        Shp = 'scribble';
        return;
      }
      if (inputText.toUpperCase() == "LINE") {
        
        //triangle(118,328, 292, 61, 446, 340);
        Cd = 100;
        mCX1 = 0;
        mCY1 = 0;
        mCX2 = 0;
        mCY2 = 0;
        //Fc = 'gold';
        //Sc = 'black';
        Shp = 'line';
        return;
      }
      if (inputText.toUpperCase() == "SAVE") {

        Shp = 'save'
        // var a = document.createElement("a");
        // document.body.appendChild(a);
        // a.style = "display: none";
        // a.href = "/ibm/bluemix/appid/logout";
        // a.click();
        return;
      }
      if (inputText.toUpperCase().substr(0,12) == "CANVAS COLOR") {
        Cc = inputText.toUpperCase().substr(13);
        background(Cc);
        return;
      }
      if (inputText.toUpperCase().substr(0,5) == "TEXT(") {

        // alert(inputText.toUpperCase().substr(0,8));
        var ltxt = inputText.toUpperCase().length-5;
        // alert(ltxt);
        var arr = inputText.toUpperCase().substr(5,ltxt-1).split(",");

        alert(arr);
        coordinateX1 = float(arr[0]);
        coordinateY1 = float(arr[1]);
        Cd = arr[2];
        textSize(Ts);
        stroke(Sc);
        strokeWeight(Ss);
        if (Fc != ''){
          fill(Fc);
        } else {
          noFill();
        }

        text(Cd, coordinateX1, coordinateY1, windowWidth - 360, 400);
        // circle(coordinateX1, coordinateY1, Cd);

        Shp = 'text'; 
        return;

      } else if (inputText.toUpperCase() == "TEXT") {
        
        Cd = '';
        mCX1 = 0;
        mCY1 = 0;
        mCX2 = 0;
        mCY2 = 0;
        //Fc = 'green';
        //Sc = 'black';
        Shp = 'text';
        return;
      }

      if (inputText.toUpperCase() == "SHOW XY") {
        if (show_coordinates){
          show_coordinates = false;
        } else {
          show_coordinates = true;
        }

        return;
      }          

      if (Shp == 'text' ) {
        
        //triangle(118,328, 292, 61, 446, 340);
        iUrl = '/content/topic/Katha-girl3.png'
        nText += inputText + "\n";

        // if (nText.length > 83){
          
        // }

        fill(Fs);
        textSize(24);

        stroke('white');
        strokeWeight(2);
        //noFill();
        //fill(255);
        //rect(10, 15, windowWidth - 325, windowHeight - 120);
        //fill(255,0,55);
        text(nText, 1, 1, windowWidth - 60, windowHeight - 80);            
        //narrateText(nText, iUrl);
        return;
      }
      if (inputText.toUpperCase().substr(0,5) == "TEXT(") {

        // alert(inputText.toUpperCase().substr(0,8));
        var ltxt = inputText.toUpperCase().length-5;
        // alert(ltxt);
        var arr = inputText.toUpperCase().substr(5,ltxt-1).split(",");

        // alert(arr);
        coordinateX1 = float(arr[0]);
        coordinateY1 = float(arr[1]);
        Cd = arr[2];
        textSize(Ts);
        stroke(Sc);
        strokeWeight(Ss);
        if (Fc != ''){
          fill(Fc);
        } else {
          noFill();
        }

        text(Cd, coordinateX1, coordinateY1, windowWidth - 360, 400);
        // circle(coordinateX1, coordinateY1, Cd);

        Shp = 'text'; 
        return;

      } else if (inputText.toUpperCase() == "TEXT") {

        Cd = '';
        mCX1 = 0;
        mCY1 = 0;
        mCX2 = 0;
        mCY2 = 0;
        //Fc = 'green';
        //Sc = 'black';
        Shp = 'text';
        return;
      }

      if (inputText.toUpperCase() == "SHOW XY") {
        if (show_coordinates){
          show_coordinates = false;
        } else {
          show_coordinates = true;
        }

        return;
      }          

      if (Shp == 'text' ) {

        //triangle(118,328, 292, 61, 446, 340);
        iUrl = '/content/topic/Katha-girl3.png'
        nText += inputText + "\n";

        // if (nText.length > 83){
          
        // }

        fill('teal');
        textSize(24);

        stroke('white');
        strokeWeight(2);
        //noFill();
        //fill(255);
        //rect(10, 15, windowWidth - 325, windowHeight - 120);
        //fill(255,0,55);
        text(nText, 1, 1, windowWidth - 60, windowHeight - 80);            
        //narrateText(nText, iUrl);
        return;
    }



      var url = baseUrl+ "/process-message"; //"converse";
      userMessage = inputText;
      // uvid.src="./public/alice.mp4";
      waitImg.src="https://responsivevoice.org/wp-content/uploads/2020/01/parrot-flight.png";
      
      
      fetch(baseUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ userMessage: userMessage, voice: "" }),
      })
        .then(response => response.json())
        .then(response => {


          const textContainer = document.getElementById("historyArea");
          const text = response.openaiResponseText;
          textContainer.style.whiteSpace = "pre-line";
          textContainer.innerText = text;

          historyArea.value += text + '\n';
          historyArea.scrollTop = historyArea.scrollHeight;
          // uvid.src="./public/alice.mp4";

          // responsiveVoice.speak(inputText,"UK English Female");  

          
          waitImg.src="";
          let array = response.openaiResponseText.split("\n");

            ctr = ctr+1;
            let bid = 'btn'+ctr.toString();
            // alert(ctr);
            var btn = document.createElement("button");
            btn.setAttribute("class", "accordion");
            btn.setAttribute("id", bid);
            btn.setAttribute("onclick","myFunction()");

            var t = document.createTextNode(inputText);
            btn.appendChild(t);
            //para.appendChild(btn);
            document.getElementById("tcon").appendChild(btn);
            
            var dv = document.createElement("DIV");
            dv.setAttribute("class", "panel");
            dv.setAttribute("style", "display: block;");
            
            var tt = document.createTextNode("cGPT Response");
            dv.appendChild(tt);
            document.getElementById("tcon").appendChild(dv);
            if (array.length > 1) {
              for (j in array) {
                let charlen = array[j].length;

                let tid = 'txt-'+j.toString()+bid;

                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");

                inf.setAttribute("id", tid);
                // if (charlen > 121 ) {
                //   inf.setAttribute("rows", "4");
                //   document.getElementById(tid).style.height = "200px";
                // }
                inf.setAttribute("value", array[j]);
                inf.setAttribute("onclick","myFunction()");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);

                responsiveVoice.speak(array[j], "UK English Male"); 
                uvid.src="./public/spn.mp4";
                               
              }
            } else {
              let sid = 'tae-'+ctr.toString()+bid;
              // alert(sid);
              var inf = document.createElement("TEXTAREA");
              inf.setAttribute("type", "text");
              inf.setAttribute("style", "color:#777;background-color:transparent;border:1px solid #ddd;font-size:14px;width:100%;height:115px;resize:none;overflow-y:scroll;");
              inf.setAttribute("id", sid);
              inf.setAttribute("onclick","myFunction()");
              inf.setAttribute("class", "form-control");
              dv.appendChild(inf);
              document.getElementById("tcon").appendChild(dv);

              let cid = document.getElementsByTagName("textarea")[sid].id;
              // alert(cid);
              document.getElementById(cid).value = array[0];

              const textContainer = document.getElementById(cid);
              const text = array[0];
              textContainer.style.whiteSpace = "pre-line";
              textContainer.innerText = text;
              
              responsiveVoice.speak(array[0], "UK English Male");
              uvid.src="./public/spn.mp4";
            }
          
            const myList = document.querySelector('#tcon')
            const lastListItem = myList.lastElementChild;
            myList.insertBefore(lastListItem, myList.firstElementChild)
            const lastListItem2 = myList.lastElementChild;
            myList.insertBefore(lastListItem2, myList.firstElementChild)

            // alert(myList.innerHTML);

          var acc = document.getElementsByClassName("accordion");
          var i;

        })
        .catch(error => {
          // Handle any errors
      });
      
    }
    function startSecondSpeech() {
      // uvid.src="./public/spn.mp4";
      // return;
        responsiveVoice.speak("Hmm", "UK English Male");
        // Add any other speech commands or actions you need to perform here
    }

    function myFunction() {
      var clickedElement = event.target;
      var clickedElementID = clickedElement.id;
      var sbsclickedElementID = clickedElementID.substring(0,3);
      var divValue;
      if (sbsclickedElementID == "txt") {
        divValue = document.getElementById(clickedElementID).value;
        responsiveVoice.speak(divValue, "UK English Male");
      chatInput.value = divValue;
      } else {
        divValue = document.getElementById(clickedElementID).innerHTML;
      }
      // alert(clickedElementID);


      var acc = document.getElementsByClassName("accordion");
      var i;

      for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.display === "block") {
            panel.style.display = "none";
          } else {
            panel.style.display = "block";
          }
        });
      }
    }

    function countCharacters() {
      var textbox = document.getElementById("chatInput");
      var charCount = document.getElementById("charCount");
      charCount.innerText = textbox.value.length + " characters";
    }


    function send_txt(ar01) {

      show_send_btn();
      if (ar01=="chatInput"){ 
        if(ncnt > 0 ) {
          //var cfid = 'fi0'+ncnt.toString();
          
          var fid = document.getElementById('fi0'+ncnt.toString());
          fid.value = chatInput.value;
        }

      } else {
      
        var x = document.getElementById(ar01);
        //x.value = x.value.toUpperCase();
        chatInput.value = x.value;
        
      }
    }
  

    function chartFunc(xValuesRT, yValuesRT, barColors){

      // document.getElementById("spnChart").style.display = "block";

      // var xValues = ["Italy", "France", "Spain", "USA", "Argentina"];
      // var yValues = [55, 49, 44, 24, 15];
      // var barColors = ["red", "green","blue","orange","brown"];

      new Chart("spnChart", {
        type: "horizontalBar",
        data: {
          labels: xValues,
          datasets: [{
            backgroundColor: barColors,
            data: yValues
          }]
        },
        options: {
          legend: {display: false},
          title: {
            display: true,
            text: "World Wine Production 2018"
          }
        }
      });
    }


    function siteControls(inputText) {
        if (inputText == 'pause video' || inputText == 'pause' || inputText == 'stop video' || inputText == 'stop')  {
          vid.pause();
          return;
        } 
        if (inputText == 'play video'|| inputText == 'play')  {
          vid.play();
          return;
        } 
        if (inputText == 'show mic'|| inputText == 'use speech' || inputText == 'use mic' || inputText == 'use microphone')  {
          document.getElementById("panel").style.display = "block";
          return;
        } 
        if (inputText == 'hide mic'|| inputText == 'no speech' || inputText == 'no mic' || inputText == 'hide microphone')  {
          document.getElementById("panel").style.display = "none";
          return;
        }    
        if (inputText == 'mute'|| inputText == 'mute sound' || inputText == 'sound off' || inputText == 'no sound')  {
          vid.muted = true;
          return;
        }
        if (inputText == 'enable sound' || inputText == 'keep sound' || inputText == 'set volume on' || inputText == 'unmute')  {
          vid.muted = false;
          return;
        }  
        if (inputText == 'show video controls' || inputText == 'show controls' || inputText == 'toggle video controls') {
          showAVControl();
          return;
        }  
        if (inputText == 'hide video controls' || inputText == 'hide controls' || inputText == 'toggle video controls') {
          showAVControl();
          return;
        } 
        if (inputText == 'show camera' || inputText == 'on camera' || inputText == 'on video' || inputText == 'enable camera')  {
          toggleAppInfo();
          return;
        } 
        if (inputText == 'hide camera' || inputText == 'off camera' || inputText == 'off video' || inputText == 'disable camera')  {
          toggleAppInfo();
          return;
        }   
        if (inputText == 'click' || inputText == 'capture' || inputText == 'start video')  {
          snapClick();
          return;
        } 

        if (inputText == 'save' || inputText == 'save' )  {
          saveFunc();
          return;
        } 

        if (inputText.toUpperCase().trim() == "QRCODE") {
            ctr = ctr+1;

            let bid = 'btn'+ctr.toString();

            var btn = document.createElement("button");
            btn.setAttribute("class", "accordion");
            btn.setAttribute("id", bid);
            btn.setAttribute("onclick","myFunction()");

            var t = document.createTextNode(inputText);
            inputText = "";
            btn.appendChild(t);
            //para.appendChild(btn);
            document.getElementById("tcon").appendChild(btn);
            var dv = document.createElement("DIV");
            dv.setAttribute("class", "panel");
            dv.setAttribute("style", "display: block;");
            dv.setAttribute("ID", "qrcode");

            var tt = document.createTextNode("QR Code Response");
            dv.appendChild(tt);
            document.getElementById("tcon").appendChild(dv);


            let cvsid = 'can-'+ctr.toString();  
            
            var can = document.createElement("DIV");
            // can.setAttribute("style", "width:100%;")
          
            can.setAttribute("ID", cvsid);

            dv.appendChild(can);
            document.getElementById("tcon").appendChild(dv);


            const myList = document.querySelector('#tcon')
            const lastListItem = myList.lastElementChild;
            myList.insertBefore(lastListItem, myList.firstElementChild)
            const lastListItem2 = myList.lastElementChild;
            myList.insertBefore(lastListItem2, myList.firstElementChild)

            // Get the URL of the current page
            var currentURL = window.location.href;

            // Generate QR code using the URL
            var qrcode = new QRCode(document.getElementById(cvsid), {
              text: currentURL,
              width: 128,
              height: 128
            });

            return;
        }
        if (inputText == 'chart' || inputText == 'bar chart' || inputText == 'line chart' || inputText == 'vertical bar chart')  {
          var c = document.querySelector('canvas');
              
              // alert(c.id);
          ctr = ctr+1;

          let bid = 'btn'+ctr.toString();



            var btn = document.createElement("button");
            btn.setAttribute("class", "accordion");
            btn.setAttribute("id", bid);
            btn.setAttribute("onclick","myFunction()");

            var t = document.createTextNode(inputText);
            btn.appendChild(t);
            //para.appendChild(btn);
            document.getElementById("tcon").appendChild(btn);


          let cvsid = 'can-'+ctr.toString();
          
          
          var can = document.createElement("canvas");
          can.setAttribute("style", "width:100%;");
        
        
          can.setAttribute("ID", cvsid);

          document.getElementById("tcon").appendChild(can);


          const myList = document.querySelector('#tcon')
          const lastListItem = myList.lastElementChild;
          myList.insertBefore(lastListItem, myList.firstElementChild)
          const lastListItem2 = myList.lastElementChild;
          myList.insertBefore(lastListItem2, myList.firstElementChild)

          
          
          // document.getElementById(cvsid).style.display = "block";
          var xValues = ["Italy", "France", "Spain", "USA", "Argentina", "Italy", "France", "Spain", "USA", "Argentina", "Italy", "France", "Spain", "USA", "Argentina"];
          var yValues = [55, 49, 44, 24, 15, 55, 49, 44, 24, 15, 55, 49, 44, 24, 15];
          var barColors = ["red", "green","blue","orange","brown"];
          var btype = "bar" //nputText.substring(0,1);

          // alert(btype);

            new Chart(cvsid, {
              type: btype,
              data: {
                labels: xValues,
                datasets: [{
                  backgroundColor: barColors,
                  data: yValues
                }]
              },
              options: {
                legend: {display: false},
                title: {
                  display: true,
                  text: "World Wine Production 2018"
                },
                scales: {
                  xAxes: [{ticks: {min: 10, max:60}}]
                }
              }
            });
            //chartFunc(xValues,yValues,barColors);
            //inputText = text +' countries '+ xValues + ' versus in percent' + yValues

            return;
        } 


        
        if (inputText == 'clear' || inputText == 'restart' )  {
          
          var list = document.getElementById("tcon");
          while (list.hasChildNodes()) {
              list.removeChild(list.firstChild);
          }
        } 

        if (inputText == 'snapClick')  {
          
          ctr = ctr+1;

          let bid = 'btn'+ctr.toString();
          var context = snapshot.getContext('2d');
          context.drawImage(player, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
          //ImgData = context.getImageData(0, 0, snapshotCanvas.width, snapshotCanvas.height);
          // var fullQuality = snapshotCanvas.toDataURL("image/jpeg", 1.0);
          // var image = new Image();
          // image.src = snapshotCanvas.toDataURL("image/jpeg", 1.0);
      
          var btn = document.createElement("button");
          btn.setAttribute("class", "accordion");
          btn.setAttribute("id", bid);
          btn.setAttribute("onclick","myFunction()");

          var t = document.createTextNode(inputText);
          btn.appendChild(t);
          //para.appendChild(btn);
          document.getElementById("tcon").appendChild(btn);

          let cvsid = 'can-'+ctr.toString();
          
          var can = document.createElement("img");
          can.setAttribute("width", "100%");
                    
          can.setAttribute("ID", cvsid);
          
          can.src = snapshotCanvas.toDataURL("image/jpeg", 1.0);
          usrImg.src = snapshotCanvas.toDataURL("image/jpeg", 1.0);

          document.getElementById("tcon").appendChild(can);


          const myList = document.querySelector('#tcon')
          const lastListItem = myList.lastElementChild;
          myList.insertBefore(lastListItem, myList.firstElementChild)
          const lastListItem2 = myList.lastElementChild;
          myList.insertBefore(lastListItem2, myList.firstElementChild)

          // return;
        } 

}   

    function viewAssets() {

      var url = "viewAssets";

      var jsondata = { requestId: "sridhar", assistant_id: assistantid, session_id: sessionid };

      ajaxJSONPost(url, jsondata, function(aresult) {
          
        jsondata = JSON.stringify(aresult);
        //alert(jsondata);
                var list = document.getElementById("tcon");
                while (list.hasChildNodes()) {
                    list.removeChild(list.firstChild);
                }
        var i, x = "";

        for (i in aresult) {

          x = i +' '+aresult[i]._id;
          an = aresult[i].assetName;
          bn = aresult[i].buildingName;
          sn = aresult[i].spaceId;
          pn = aresult[i].phone;

                var para = document.createElement("P");
                var btn = document.createElement("Button");
                btn.setAttribute("class", "accordion");
                var t = document.createTextNode(x);
                btn.appendChild(t);
                //para.appendChild(btn);
                document.getElementById("tcon").appendChild(btn);
                var dv = document.createElement("DIV");
                dv.setAttribute("class", "panel");


                var tt = document.createTextNode("Asset Name");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", an);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);


                var tt = document.createTextNode("Building Name");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", bn);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);


                var tt = document.createTextNode("Space Id");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", sn);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);


                var tt = document.createTextNode("Phone");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);

                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", pn);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);

                    
        }

        var acc = document.getElementsByClassName("accordion");
        var i;

        for (i = 0; i < acc.length; i++) {
          acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        }

      });
      
    }


    function viewTickets() {

      var url = "viewTickets";

      var jsondata = { requestId: "sridhar", assistant_id: assistantid, session_id: sessionid };

      ajaxJSONPost(url, jsondata, function(aresult) {
          
        jsondata = JSON.stringify(aresult);
        //alert(jsondata);
                var list = document.getElementById("tcon");
                while (list.hasChildNodes()) {
                    list.removeChild(list.firstChild);
                }
        var i, x = "";

        for (i in aresult) {

          x = i +' '+aresult[i]._id;
          ip = aresult[i].issue;
          bn = aresult[i].buildingName;
          wd = aresult[i].weekDay;
          dt = aresult[i].dayTime;
          pn = aresult[i].phone;

                var para = document.createElement("P");
                var btn = document.createElement("Button");
                btn.setAttribute("class", "accordion");
                var t = document.createTextNode(x);
                btn.appendChild(t);
                //para.appendChild(btn);
                document.getElementById("tcon").appendChild(btn);
                var dv = document.createElement("DIV");
                dv.setAttribute("class", "panel");


                var tt = document.createTextNode("Issue");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", ip);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);


                var tt = document.createTextNode("Building Name");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", bn);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);


                var tt = document.createTextNode("Week Day");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", wd);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);


                var tt = document.createTextNode("Time");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);
               
                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", dt);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);

                var tt = document.createTextNode("Phone");
                dv.appendChild(tt);
                document.getElementById("tcon").appendChild(dv);

                var inf = document.createElement("INPUT");
                inf.setAttribute("type", "text");
                inf.setAttribute("value", pn);
                //inf.setAttribute("id", ar0);
                //inf.setAttribute("onkeyup", "send_txt(id)");
                inf.setAttribute("class", "form-control");
                dv.appendChild(inf);
                document.getElementById("tcon").appendChild(dv);

                    
        }

        var acc = document.getElementsByClassName("accordion");
        var i;

        for (i = 0; i < acc.length; i++) {
          acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        }

      }); 
      

    }


    function delsession() {

      var url = "delsession";

      var jsondata = { requestId: "sridhar", assistant_id: assistantid, session_id: sessionid };
    
      ajaxJSONPosta(url, jsondata, function(response) {
          
        alert(JSON.stringify(response))

      });
    }
    
    window
        .addEventListener(
            'load',
            function() {
              //showVButtons('none');
              //updateImage('');
              var c = document.querySelector('canvas');
              
              // alert(c.id);
              // Get the canvas element
              const canvas = document.getElementById("defaultCanvas0");

              // Get the label element
              const aside = document.getElementById("asideLabel");
              
              // Move the canvas inside the label
              aside.appendChild(canvas);

              Shp = "onload"
              document.getElementById("toggle").click();
              // document.getElementById("panel").style.display = "none";
                 
                  // siteControls(inputText);  




              initiate(assistantid);

              historyArea.value += 
                      "me>> "+ "You're not authenticated :(" + "\n";
                  historyArea.scrollTop = historyArea.scrollHeight; 

              // document.getElementById("spnChart").style.display = "none";
              // const canvas = document.getElementById("defaultCanvas0");
              // const canvasContainer = document.getElementById("canvasContainer");
              // if (canvas && canvasContainer) {
              //     canvasContainer.appendChild(canvas);
              // }
              // uvid.src="https://cdn2.veltra.com/ptr/20180427105257_558150640_10498_0.jpg";
              waitImg.src="";
              uvid.style.display = "block"; 
              // usrImg.src="https://cdn2.veltra.com/ptr/20180427105257_558150640_10498_0.jpg";
              cmsImg.src="https://responsivevoice.org/wp-content/uploads/2020/01/parrot-flight.png"
              //startButton(event);
              // sendConverse("Jargon of the day");

              // setTimeout('loadJson("' + BASE_CMS_URL + '/content/json/escape101.json")', imagePlayInterval);

            });
    
    (function() {
      document
          .getElementById('chatInput')
          .addEventListener(
              'keydown',
              function(e) {
                if (e.keyCode === 13) {
                  //send_button.style.display = 'none';
                  var inputText = this.value;
                  if (inputText != ""){
                    historyArea.value += 
                      'me>> '+ inputText + '\n';
                    historyArea.scrollTop = historyArea.scrollHeight;                  
                  // siteControls(inputText);  
                    sendConverse(inputText);
                  }
                  this.value = ''; 
                }
                if (e.keyCode === 27) {
                  sendConverse("CLEAR");
                }  
                // if (e.keyCode === 37) {
                //   sendConverse("MOVE LEFT");
                // }   
                // if (e.keyCode === 38) { 
                //   sendConverse("MOVE TOP");
                // }
                // if (e.keyCode === 39) {
                //   sendConverse("MOVE RIGHT");
                // }   
                // if (e.keyCode === 40) {
                //   sendConverse("MOVE DOWN");
                // }  
              });
    })();

/*  
    $(window).on("beforeunload", function() { 
      var closeText = 'Okay, bye!';
      kathaClose(closeText);
      return closeText; 
    })
*/


function updateImage(srcUri) {
      //console.log('Locating image: ' + BASE_CMS_URL + '/' + srcUri);
      //$('cmsImage').attr('src', BASE_CMS_URL + '/' + srcUri);  
      //document.getElementById("usrImg").src = BASE_CMS_URL + '/' + srcUri;
      if (srcUri.substr(0,4) == 'http')
      {
		    document.getElementById("cmsImg").src = srcUri;
      } else {
      	document.getElementById("cmsImg").src = BASE_CMS_URL + '/' + srcUri;
      }

    }

    function playNextImage(count, bid) { 
      var nextImage = globalContentJsonObj.images[+count];
      var vdourl = "";
      //var vid = document.getElementById("myVideo");
      var jid = globalContentJsonObj.id;
      // ctr = ctr+1;
      // clear();
      fill('');
      textSize(30);

      stroke('black');
      strokeWeight(3);
      clear();
      if (jid == "video") {
          
          vdourl = BASE_CMS_URL +'/'+ nextImage.uri;
          document.getElementById("cmsImg").src = "";

         //document.getElementById("cmsImg").style.display = "none";
          //document.getElementById("vdo").style.display = "block";
          //showVButtons('inline-block');
          // uvid.style.display = "block";
          // uvid.src = vdourl;
          // uvid.load();

      } else {
      //   if (ctr == 1 ) {
      //       let bid = 'btn'+ctr.toString();
      //       // alert(ctr);
      //       var btn = document.createElement("button");
      //       btn.setAttribute("class", "accordion");
      //       btn.setAttribute("id", bid);
      //       btn.setAttribute("onclick","myFunction()");

      //       var t = document.createTextNode("Introduction to Escape!!");
      //       btn.appendChild(t);
      //       //para.appendChild(btn);
      //       document.getElementById("tcon").appendChild(btn);
            
      // }
      //       var dv = document.createElement("DIV");
      //       dv.setAttribute("class", "panel");
      //       // dv.setAttribute("style", "display: block;");
      //       dv.setAttribute("style", "display: block; font-size: 20px; font-family: Arial, sans-serif;");
            
      //       var tt = document.createTextNode(nextImage.description);
      //       dv.appendChild(tt);
      //       document.getElementById("tcon").appendChild(dv);
            
      //   let tid = 'txt-'+count.toString()+bid;

        // var inf = document.createElement("INPUT");
        // inf.setAttribute("type", "text");

        // inf.setAttribute("id", tid);
        // // if (charlen > 121 ) {
        // //   inf.setAttribute("rows", "4");
        // //   document.getElementById(tid).style.height = "200px";
        // // }
        // inf.setAttribute("value", nextImage.description);
        // inf.setAttribute("onclick","myFunction()");
        // inf.setAttribute("class", "form-control");
        // dv.appendChild(inf);
        // document.getElementById("tcon").appendChild(dv);

        // responsiveVoice.speak(array[j], "UK English Male");           
          // uvid.src = "";
          // uvid.style.display = "none";
          //showVButtons('none');
          //document.getElementById("vdo").style.display = "none";
        // iUrl = '/content/topic/Katha-girl3.png'
        document.getElementById("cmsImg").style.display = "block";
        // updateImage(nextImage.uri);
        responsiveVoice.speak(nextImage.description, "UK English Male");
        historyArea.value += nextImage.description + '\n';
        historyArea.scrollTop = historyArea.scrollHeight;
        // text(Cd, mouseX, mouseY, windowWidth - 380, 480);
        text(nextImage.description, 80, 50, windowWidth, windowHeight);            
        // narrateText(nText, iUrl);
        count++;
        if(count < globalContentJsonObj.images.length)
        setTimeout('playNextImage('+count+')', 12000); 

      }
    }


    function cplayNextImage(count, bid) { 
      var nextImage = globalContentJsonObj.images[+count];
      var vdourl = "";
      // alert(globalContentJsonObj.name);
      //var vid = document.getElementById("myVideo");
      var jid = globalContentJsonObj.id;
      // clear()
      // fill('');
      // textSize(30);

      // stroke('black');
      // strokeWeight(3);
      // clear();
      if (jid == "video") {
          
          vdourl = BASE_CMS_URL +'/'+ nextImage.uri;
          document.getElementById("cmsImg").src = "";

         //document.getElementById("cmsImg").style.display = "none";
          //document.getElementById("vdo").style.display = "block";
          //showVButtons('inline-block');
          // uvid.style.display = "block";
          // uvid.src = vdourl;
          // uvid.load();

      } else {

            bid = 'btn'+ ctr.toString();
            // alert(ctr);
            var btn = document.createElement("button");
            btn.setAttribute("class", "accordion");
            btn.setAttribute("id", bid);
            btn.setAttribute("onclick","myFunction()");

            var t = document.createTextNode(nextImage.title);
            btn.appendChild(t);
            //para.appendChild(btn);
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            btn.appendChild(checkbox);
            
            document.getElementById("tcon").appendChild(btn);

            var dv = document.createElement("DIV");
            dv.setAttribute("class", "panel");
            // dv.setAttribute("style", "display: block;");
            dv.setAttribute("style", "display: block; font-size: 16px; font-family: Arial, sans-serif;");
            
            var tt = document.createTextNode(nextImage.description);
            dv.appendChild(tt);
            document.getElementById("tcon").appendChild(dv);
            
        let tid = 'txt-'+count.toString()+bid;

        var inf = document.createElement("INPUT");
        inf.setAttribute("type", "text");

        inf.setAttribute("id", tid);
        // if (charlen > 121 ) {
        //   inf.setAttribute("rows", "4");
        //   document.getElementById(tid).style.height = "200px";
        // }
        inf.setAttribute("value", "");
        inf.setAttribute("onclick","myFunction()");
        inf.setAttribute("class", "form-control");
        dv.appendChild(inf);
        document.getElementById("tcon").appendChild(dv);

        // responsiveVoice.speak(array[j], "UK English Male");           
          // uvid.src = "";
          // uvid.style.display = "none";
          //showVButtons('none');
          //document.getElementById("vdo").style.display = "none";
        // iUrl = '/content/topic/Katha-girl3.png'
        document.getElementById("cmsImg").style.display = "block";
        // updateImage(nextImage.uri);
        // responsiveVoice.speak(nextImage.description, "UK English Male");
        historyArea.value += nextImage.description + '\n';
        historyArea.scrollTop = historyArea.scrollHeight;
        // text(Cd, mouseX, mouseY, windowWidth - 380, 480);
        // text(nextImage.description, 80, 50, windowWidth, windowHeight);            
        // narrateText(nText, iUrl);
        count++;
        if(count < globalContentJsonObj.images.length)
        setTimeout('cplayNextImage('+count+')', 100); 

      }
    }
    function cplayImageList() {
 
      ctr = ctr+1;
      // bid = 'btn'+ ctr.toString();
      //       // alert(ctr);
      //       var btn = document.createElement("button");
      //       btn.setAttribute("class", "accordion");
      //       btn.setAttribute("id", bid);
      //       btn.setAttribute("onclick","myFunction()");

      //       var t = document.createTextNode("Introduction to Escape!!");
      //       btn.appendChild(t);
      //       //para.appendChild(btn);
      //       document.getElementById("tcon").appendChild(btn);
            
      cplayNextImage(0, bid);
      
    }
    function playImageList() {
      playNextImage(0);
    }
    function startmic() {
      start_button(event);
    }
    function aloadJson(jsonUri, response) {
      //alert('jsonUri - ', jsonUri);
      console.log('Locating content json: '+jsonUri);
      var axhr = new XMLHttpRequest();
      axhr.open("POST", jsonUri, true);
      axhr.withCredentials = true;
      axhr.setRequestHeader('Content-Type', 'application/json');
      axhr.onload = function() {
        if (axhr.status === 200) {
          //alert(JSON.stringify(response));
          //alert('GET JSON: ', axhr.responseText);
          globalContentJsonObj = JSON.parse(axhr.responseText);
          //alert('in NewloadJson '+ JSON.stringify(globalContentJsonObj));
          console.log('JSON received: '+JSON.stringify(globalContentJsonObj));
          //console.log(globalContentJsonObj.images.length + ' images in the json file.');
          var imglen = globalContentJsonObj.images.length;
          //alert(imglen);
        if(globalContentJsonObj.images && (globalContentJsonObj.images.length > 0))
          playImageList(); 
        }
        else {
            //alert('Request failed.  Returned status of ' + axhr.status);
            document.getElementById('statusLine').value = "Return status = " + axhr.status;
        }
      }
      axhr.send();
    }
    function cloadJson(jsonUri) {
          console.log('Locating content json: '+jsonUri);

        $.getJSON(jsonUri, function(jsonObj) {
          globalContentJsonObj = jsonObj;

          console.log('JSON received: '+JSON.stringify(globalContentJsonObj));
          console.log(globalContentJsonObj.images.length + ' images in the json file.');
          //var imglen = globalContentJsonObj.images.length;
          if(globalContentJsonObj.images && (globalContentJsonObj.images.length > 0)) {
                  // // Extract the "images" array from the JSON
                  // const imagesArray = globalContentJsonObj.images;

                  // // Create an empty array to store the converted data
                  // const storedValues = [];

                  // // Loop through the "images" array and convert each object
                  // for (const image of imagesArray) {
                  //     const item = {
                  //         thumbnail: image.thumbnail,
                  //         uri: image.uri,
                  //         title: image.title,
                  //         description: image.description,
                  //     };
                  //     storedValues.push(item);
                  // }

                  // // Now, the "storedValues" array contains the converted data
                  // console.log(storedValues);  
            cplayImageList(); 
          }
          
      });
    }


    function loadJson(jsonUri) {
          console.log('Locating content json: '+jsonUri);

        $.getJSON(jsonUri, function(jsonObj) {
          globalContentJsonObj = jsonObj;

          console.log('JSON received: '+JSON.stringify(globalContentJsonObj));
          console.log(globalContentJsonObj.images.length + ' images in the json file.');
          //var imglen = globalContentJsonObj.images.length;
          if(globalContentJsonObj.images && (globalContentJsonObj.images.length > 0))
          playImageList(); 
      });
    }
    function setBGImage() {
        //document.body.style.backgroundImage = "url('images/Katha_Speak_teen.png')";  
    } 

    const personas = [
      {
        name: 'Alice',
        greeting: 'Yeah, WHats Up!!',
        skills: ['programming', 'design'],
        display_image: 'alice.jpg',
        intro_video: 'alice_intro.mp4',
        languages_spoken: ['English', 'Spanish']
      },
      {
        name: 'Margarita',
        greeting: 'I am listening',
        skills: ['marketing', 'sales'],
        display_image: 'margarita.jpg',
        intro_video: 'bob_intro.mp4',
        languages_spoken: ['English', 'French']
      },
      {
        name: 'SPN',
        greeting: 'Hey There, nice to hear your voice!!',
        skills: ['marketing', 'sales'],
        display_image: 'margarita.jpg',
        intro_video: 'bob_intro.mp4',
        languages_spoken: ['English', 'French']
      },
      // Add more personas as needed
    ];

</script> 
<script>
var langs =
[['Afrikaans',       ['af-ZA']],
 ['Bahasa Indonesia',['id-ID']],
 ['Bahasa Melayu',   ['ms-MY']],
 ['Catal',          ['ca-ES']],
 ['etina',         ['cs-CZ']],
 ['Deutsch',         ['de-DE']],
 ['English',         ['en-AU', 'Australia'],
                     ['en-CA', 'Canada'],
                     ['en-IN', 'India'],
                     ['en-NZ', 'New Zealand'],
                     ['en-ZA', 'South Africa'],
                     ['en-GB', 'United Kingdom'],
                     ['en-US', 'United States']],
 ['Espaol',         ['es-AR', 'Argentina'],
                     ['es-BO', 'Bolivia'],
                     ['es-CL', 'Chile'],
                     ['es-CO', 'Colombia'],
                     ['es-CR', 'Costa Rica'],
                     ['es-EC', 'Ecuador'],
                     ['es-SV', 'El Salvador'],
                     ['es-ES', 'Espaa'],
                     ['es-US', 'Estados Unidos'],
                     ['es-GT', 'Guatemala'],
                     ['es-HN', 'Honduras'],
                     ['es-MX', 'Mxico'],
                     ['es-NI', 'Nicaragua'],
                     ['es-PA', 'Panam'],
                     ['es-PY', 'Paraguay'],
                     ['es-PE', 'Per'],
                     ['es-PR', 'Puerto Rico'],
                     ['es-DO', 'Repblica Dominicana'],
                     ['es-UY', 'Uruguay'],
                     ['es-VE', 'Venezuela']],
 ['Euskara',         ['eu-ES']],
 ['Franais',        ['fr-FR']],
 ['Galego',          ['gl-ES']],
 ['Hrvatski',        ['hr_HR']],
 ['IsiZulu',         ['zu-ZA']],
 ['slenska',        ['is-IS']],
 ['Italiano',        ['it-IT', 'Italia'],
                     ['it-CH', 'Svizzera']],
 ['Magyar',          ['hu-HU']],
 ['Nederlands',      ['nl-NL']],
 ['Norsk bokml',    ['nb-NO']],
 ['Polski',          ['pl-PL']],
 ['Portugus',       ['pt-BR', 'Brasil'],
                     ['pt-PT', 'Portugal']],
 ['Romn',          ['ro-RO']],
 ['Slovenina',      ['sk-SK']],
 ['Suomi',           ['fi-FI']],
 ['Svenska',         ['sv-SE']],
 ['Trke',          ['tr-TR']],
 ['',       ['bg-BG']],
 ['P',         ['ru-RU']],
 ['',          ['sr-RS']],
 ['',            ['ko-KR']],
 ['',             ['cmn-Hans-CN', ' ()'],
                     ['cmn-Hans-HK', ' ()'],
                     ['cmn-Hant-TW', ' ()'],
                     ['yue-Hant-HK', ' ()']],
 ['',           ['ja-JP']],
 ['Lingua latna',   ['la']]];
for (var i = 0; i < langs.length; i++) {
  select_language.options[i] = new Option(langs[i][0], i);
}
select_language.selectedIndex = 6;
updateCountry();
select_dialect.selectedIndex = 6;
showInfo('info_start');
function updateCountry() {
  for (var i = select_dialect.options.length - 1; i >= 0; i--) {
    select_dialect.remove(i);
  }
  var list = langs[select_language.selectedIndex];
  for (var i = 1; i < list.length; i++) {
    select_dialect.options.add(new Option(list[i][1], list[i][0]));
  }
  select_dialect.style.visibility = list[1].length == 1 ? 'hidden' : 'visible';
}
var create_email = false;
var final_transcript = '';
var recognizing = false;
var ignore_onend;
var start_timestamp;
if (!('webkitSpeechRecognition' in window)) {
  upgrade();
} else {
  start_button.style.display = 'inline-block';
  var recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.onstart = function() {
    recognizing = true;
    showInfo('info_speak_now');
    start_img.src = 'mic-animate.gif';
  };
  recognition.onerror = function(event) {
    if (event.error == 'no-speech') {
      start_img.src = 'mic.gif';
      showInfo('info_no_speech');
      ignore_onend = true;
    }
    if (event.error == 'audio-capture') {
      start_img.src = 'mic.gif';
      showInfo('info_no_microphone');
      ignore_onend = true;
    }
    if (event.error == 'not-allowed') {
      if (event.timeStamp - start_timestamp < 100) {
        showInfo('info_blocked');
      } else {
        showInfo('info_denied');
      }
      ignore_onend = true;
    }
  };
  recognition.onend = function() {
    recognizing = false;
    if (ignore_onend) {
      return;
    }
    start_img.src = 'mic.gif';
    if (!final_transcript) {
      showInfo('info_start');
      return;
    }
    showInfo('');
    if (window.getSelection) {
      window.getSelection().removeAllRanges();
      var range = document.createRange();
      range.selectNode(document.getElementById('final_span'));
      window.getSelection().addRange(range);
    }
    if (final_transcript) {
      showInfo('info_start');
      var inputText = final_transcript;
      final_transcript = '';
      final_span.innerHTML = '';
      interim_span.innerHTML = '';
      chatInput.value = inputText;
      send_txt("chatInput");
    }
    if (create_email) {
      create_email = false;
      createEmail();
    }
  };
//   recognition.onresult = function(event) {
//     var interim_transcript = '';
//     for (var i = event.resultIndex; i < event.results.length; ++i) {
//       if (event.results[i].isFinal) {
//         final_transcript += event.results[i][0].transcript;
//       } else {
//         interim_transcript += event.results[i][0].transcript;
//       }
//     }
//     final_transcript = capitalize(final_transcript);
//     final_span.innerHTML = linebreak(final_transcript);
//     interim_span.innerHTML = linebreak(interim_transcript);
//     if (final_transcript || interim_transcript) {
//       //showButtons('inline-block');
//     }
//   };
// }

recognition.onresult = function(event) {
    var interim_transcript = '';
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        final_transcript += event.results[i][0].transcript;
      } else {
        interim_transcript += event.results[i][0].transcript;
      }
    }
    final_transcript = capitalize(final_transcript);
    final_span.innerHTML = linebreak(final_transcript);
    interim_span.innerHTML = linebreak(interim_transcript);    
    
    if (final_transcript == 'Alice'|| final_transcript == 'alice' || interim_transcript == 'Alice') {
        wakeWord = true;
          if (wakeWord) {
            uvid.src="./public/alice.mp4";
            persona = "ALICE";
            recognition.stop();
            responsiveVoice.speak("Hey, I am listening. ");
            
            historyArea.value += 'Hey, I am listening. ' + '\n';
            historyArea.scrollTop = historyArea.scrollHeight;    
            final_transcript = '';      
          } 
          setTimeout(function() {recognition.start()}, 5000);
            //showButtons('inline-block');
    }
    if (final_transcript == 'Margarita'|| final_transcript == 'Margaritha' || interim_transcript == 'Margarita') {
        wakeWord = true;
          if (wakeWord) {
            uvid.src="./public/alice.mp4";
            persona = "MARGARITA";
            recognition.stop();
            responsiveVoice.speak("Hey, I am listening. ");
            
            historyArea.value += 'Hey, I am listening. ' + '\n';
            historyArea.scrollTop = historyArea.scrollHeight;    
            final_transcript = '';      
          } 
          setTimeout(function() {recognition.start()}, 5000);
            //showButtons('inline-block');
    }
    if (final_transcript == 'Brian'|| final_transcript == 'Bryan' || interim_transcript == 'Brian') {
        wakeWord = true;
          if (wakeWord) {
            uvid.src="./public/brian.mp4";
            persona = "BRIAN";
            recognition.stop();
            responsiveVoice.speak("Hello There, Shoud I start the SOD meeting?", "UK English Male");
            
            historyArea.value += 'Hello There, Shoud I get started with the SOD meeting?' + '\n';
            historyArea.scrollTop = historyArea.scrollHeight;    
            final_transcript = '';      
          } 
          setTimeout(function() {recognition.start()}, 5000);
            //showButtons('inline-block');
    }
    if (final_transcript == 'SPN'|| final_transcript == 'SRI' || interim_transcript == 'SPN'|| interim_transcript == 'SRI') {
        wakeWord = true;
          if (wakeWord) {
            uvid.src="./public/spn.mp4";
            persona = "SPN";
            recognition.stop();
            responsiveVoice.speak("Hey There, Been a Long time?", "UK English Male");
            
            historyArea.value += 'Hey There, Been a Long time?' + '\n';
            historyArea.scrollTop = historyArea.scrollHeight;    
            final_transcript = '';      
          } 
          setTimeout(function() {recognition.start()}, 5000);
            //showButtons('inline-block');
    }

    // if (recognizing && wakeWord == true) {
      if (final_transcript.length >= 2){
        recognition.stop();
        chatInput.value = final_transcript;
        var inputText = final_transcript;
        var sb = final_transcript;
        final_transcript = '';  
        recognizing = false;
        historyArea.value += 'me>> '+ sb + '\n';
        historyArea.scrollTop = historyArea.scrollHeight;
        final_span.innerHTML = '';
        interim_span.innerHTML = '';
        chatInput.value = inputText;
        send_txt("chatInput");
        sendConverse(sb);

      }
    // }
  };
}



function wakeWordF(event) {
  
  final_transcript = '';
  recognition.lang = select_dialect.value;
  if (!recognizing && wakeWord == false) {
    recognition.start();
    wakeWord == true;
  }
  ignore_onend = false;
  final_span.innerHTML = '';
  interim_span.innerHTML = '';
  //start_img.src = 'mic-slash.gif';
  showInfo('info_allow');
  showButtons('none');
}

function upgrade() {
  start_button.style.visibility = 'hidden';
  showInfo('info_upgrade');
}
var two_line = /\n\n/g;
var one_line = /\n/g;
function linebreak(s) {
  return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
}
var first_char = /\S/;
function capitalize(s) {
  return s.replace(first_char, function(m) { return m.toUpperCase(); });
}
function createEmail() {
  var n = final_transcript.indexOf('\n');
  if (n < 0 || n >= 80) {
    n = 40 + final_transcript.substring(40).indexOf(' ');
  }
  var subject = encodeURI(final_transcript.substring(0, n));
  var body = encodeURI(final_transcript.substring(n + 1));
  window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
}
function sendButton() {
  //send_button.style.display = 'none';
  var sb = chatInput.value;
  historyArea.value += 'me>> '+ sb + '\n';
  historyArea.scrollTop = historyArea.scrollHeight;
  chatInput.value = '';
  // siteControls(sb);
  sendConverse(sb);
  //kathaConverse(sb);
}
function copyButton() {
  if (recognizing) {
    recognizing = false;
    recognition.stop();
  }
  copy_button.style.display = 'none';
  copy_info.style.display = 'inline-block';
  showInfo('');
}
function emailButton() {
  if (recognizing) {
    create_email = true;
    recognizing = false;
    recognition.stop();
  } else {
    createEmail();
  }
  email_button.style.display = 'none';
  email_info.style.display = 'inline-block';
  showInfo('');
}
function startButton(event) {
  
  if (recognizing) {
    recognition.stop();
    showButtons('inline-block');
    return;
  }
  final_transcript = '';
  recognition.lang = select_dialect.value;
  recognition.start();
  ignore_onend = false;
  final_span.innerHTML = '';
  interim_span.innerHTML = '';
  start_img.src = 'mic-slash.gif';
  showInfo('info_allow');
  showButtons('none');
  start_timestamp = event.timeStamp;

}
function showInfo(s) {
  if (s) {
    for (var child = info.firstChild; child; child = child.nextSibling) {
      if (child.style) {
        child.style.display = child.id == s ? 'inline' : 'none';
      }
    }
    info.style.visibility = 'visible';
  } else {
    info.style.visibility = 'hidden';
  }
}
var current_style;
function showButtons(style) {
  if (style == current_style) {
    return;
  }
  current_style = style;
  //send_button.style.display = style;
  //copy_button.style.display = style; 
  //email_button.style.display = style;
 // copy_info.style.display = 'none';
 // email_info.style.display = 'none';
}

</script>
<script src="https://code.responsivevoice.org/responsivevoice.js?key=zYY4ho3R"></script>

</body>

</html>